name: CI - Build, Test, Terraform Plan

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run workflow on'
        required: true
        default: 'main'

jobs:
  build-test:
    name: Run tests and build Lambda artifacts
    runs-on: ubuntu-latest
    env:
      GO111MODULE: on
      AWS_REGION: ap-south-1
      TF_IN_AUTOMATION: true
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install dependencies
        run: go mod download

      # - name: Run unit tests
      #   run: go test ./... -v

      # - name: LocalStack start
      #   uses: localstack/setup-localstack@v1
      #   with:
      #     services: dynamodb,sqs,lambda
      #     image-tag: "latest"
      #     install-awslocal: "true"

      # - name: Run integration tests (LocalStack)
      #   run: |
      #     echo "Running integration tests..."
      #     GOOS=linux go test ./tests/integration -v

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_CI }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_CI }}
          aws-region: ap-south-1

      - name: Set S3 Artifact Bucket
        run: |
          echo "S3_ARTIFACT_BUCKET=orderflow-artifacts" >> $GITHUB_ENV

      - name: Build API Lambda
        run: |
          mkdir -p build
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o build/api ./cmd/api
          zip -j build/api.zip build/api

      - name: Build Worker Lambda
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o build/worker ./cmd/worker
          zip -j build/worker.zip build/worker

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Upload to S3 (Artifact Bucket)
        run: |
          aws s3 cp build/api.zip s3://$S3_ARTIFACT_BUCKET/pipelines/${{ github.sha }}/api.zip
          aws s3 cp build/worker.zip s3://$S3_ARTIFACT_BUCKET/pipelines/${{ github.sha }}/worker.zip

      - name: Terraform Init
        run: terraform -chdir=infra/terraform/envs/staging init -input=false

      - name: Terraform Plan
        run: |
          terraform -chdir=infra/terraform/envs/staging plan -out=tfplan \
            -var "lambda_s3_bucket=$S3_ARTIFACT_BUCKET" \
            -var "lambda_api_s3_key=pipelines/${{ github.sha }}/api.zip" \
            -var "lambda_worker_s3_key=pipelines/${{ github.sha }}/worker.zip"

      - name: Render Terraform Plan (text)
        run: |
          terraform -chdir=infra/terraform/envs/staging show -no-color tfplan > infra/terraform/envs/staging/tfplan.txt

      - name: Upload Terraform Plan to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const plan = fs.readFileSync('infra/terraform/envs/staging/tfplan.txt', 'utf8')
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "### Terraform Plan\n```\n" + plan + "\n```"
            })
